# RabbitMQ Configuration for Fenix NFe API
# Otimizado para produção

#------------------------------------------------------------------------------
# NETWORKING
#------------------------------------------------------------------------------
listeners.tcp.default = 5672
management.tcp.port = 15672
management.tcp.ip = 0.0.0.0

#------------------------------------------------------------------------------
# MEMORY MANAGEMENT
#------------------------------------------------------------------------------
vm_memory_high_watermark.relative = 0.6
vm_memory_high_watermark_paging_ratio = 0.5
disk_free_limit.relative = 2.0

#------------------------------------------------------------------------------
# CLUSTERING
#------------------------------------------------------------------------------
cluster_formation.peer_discovery_backend = classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
log.console = true
log.console.level = info
log.file = true
log.file.level = info
log.file.rotation.date = $D0
log.file.rotation.size = 0

#------------------------------------------------------------------------------
# PERFORMANCE
#------------------------------------------------------------------------------
# Connection limits
connection_max = 1000
channel_max = 2000

# Heartbeat
heartbeat = 60

# Frame size
frame_max = 131072

# Socket options
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.keepalive = true
tcp_listen_options.exit_on_close = false

#------------------------------------------------------------------------------
# QUEUE SETTINGS
#------------------------------------------------------------------------------
# Queue TTL
queue_master_locator = min-masters

# Message TTL
default_user_tags.administrator = true

#------------------------------------------------------------------------------
# MANAGEMENT
#------------------------------------------------------------------------------
management.load_definitions = /etc/rabbitmq/definitions.json
management.http_log_dir = /var/log/rabbitmq/management-access.log

#------------------------------------------------------------------------------
# SECURITY
#------------------------------------------------------------------------------
# Disable guest user
default_user = fenix_user
default_pass = fenix_password
default_vhost = /
default_permissions.configure = .*
default_permissions.read = .*
default_permissions.write = .*

#------------------------------------------------------------------------------
# PLUGINS
#------------------------------------------------------------------------------
management.tcp.port = 15672
management.tcp.ip = 0.0.0.0
management.ssl.port = 15671
management.ssl.cacertfile = /etc/ssl/certs/ca-certificates.crt
management.ssl.certfile = /etc/ssl/certs/rabbitmq-server.crt
management.ssl.keyfile = /etc/ssl/private/rabbitmq-server.key

#------------------------------------------------------------------------------
# POLICIES
#------------------------------------------------------------------------------
# Dead letter queue policy
default_policies = [
  {name = "dlq-policy", pattern = ".*", definition = {dead-letter-exchange = "dlx"}},
  {name = "ttl-policy", pattern = ".*", definition = {message-ttl = 3600000}}
]

#------------------------------------------------------------------------------
# EXCHANGES
#------------------------------------------------------------------------------
# Dead letter exchange
default_exchanges = [
  {name = "dlx", type = "direct", durable = true}
]

#------------------------------------------------------------------------------
# QUEUES
#------------------------------------------------------------------------------
# NFe queues
default_queues = [
  {name = "nfe.emitir.high", durable = true, arguments = {x-message-ttl = 300000, x-max-length = 10000}},
  {name = "nfe.emitir.normal", durable = true, arguments = {x-message-ttl = 600000, x-max-length = 50000}},
  {name = "nfe.emitir.low", durable = true, arguments = {x-message-ttl = 1800000, x-max-length = 100000}},
  {name = "nfe.consulta", durable = true, arguments = {x-message-ttl = 300000, x-max-length = 10000}},
  {name = "nfe.evento", durable = true, arguments = {x-message-ttl = 300000, x-max-length = 10000}},
  {name = "nfe.retry", durable = true, arguments = {x-message-ttl = 3600000, x-max-length = 50000}},
  {name = "nfe.dlq", durable = true, arguments = {x-message-ttl = 86400000, x-max-length = 100000}}
]

#------------------------------------------------------------------------------
# BINDINGS
#------------------------------------------------------------------------------
default_bindings = [
  {source = "nfe.emitir", destination = "nfe.emitir.high", routing_key = "high"},
  {source = "nfe.emitir", destination = "nfe.emitir.normal", routing_key = "normal"},
  {source = "nfe.emitir", destination = "nfe.emitir.low", routing_key = "low"},
  {source = "nfe.retry", destination = "nfe.emitir", routing_key = "retry"},
  {source = "nfe.dlq", destination = "dlx", routing_key = "dlq"}
]
